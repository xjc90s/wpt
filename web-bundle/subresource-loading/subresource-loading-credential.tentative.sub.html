<!DOCTYPE html>
<title>
  crossorigin= attribute and credentials in WebBundle subresource loading
</title>
<link
  rel="help"
  href="https://github.com/WICG/webpackage/blob/master/explainers/subresource-loading.md"
/>
<link
  rel="help"
  href="https://html.spec.whatwg.org/multipage/#cors-settings-attribute"
/>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<body>
  <script>
    document.cookie = "milk=yes";

    const same_origin_bundle = "./check-cookie-and-return-bundle.py";
    const cross_origin_bundle = new URL(same_origin_bundle, window.location);
    cross_origin_bundle.port = {{ports[http][1]}};

    promise_test(async () => {
      const link = document.createElement("link");
      link.rel = "webbundle";
      link.href = same_origin_bundle;
      await addLinkAndWaitForLoad(link);
      link.remove()
    }, "'no crossorigin attribute' should send a credential to a same origin bundle");

    promise_test(async () => {
      const link = document.createElement("link");
      link.rel = "webbundle";
      link.href = cross_origin_bundle;
      await addLinkAndWaitForLoad(link);
      link.remove()
    }, "'no crossorigin attribute' should send a credential to a cross origin bundle");

    promise_test(async () => {
      const link = document.createElement("link");
      link.rel = "webbundle";
      link.href = same_origin_bundle;
      link.crossOrigin = "anonymous";
      await addLinkAndWaitForLoad(link);
      link.remove()
    }, "'anonymous' should send a credential to a same origin bundle");

    promise_test(async () => {
      const link = document.createElement("link");
      link.rel = "webbundle";
      link.href = cross_origin_bundle;
      link.crossOrigin = "anonymous";
      await addLinkAndWaitForError(link);
      link.remove()
    }, "'anonymous' should not send a credential to a cross origin bundle");

    promise_test(async () => {
      const link = document.createElement("link");
      link.rel = "webbundle";
      link.href = same_origin_bundle;
      link.crossOrigin = "use-credentials";
      await addLinkAndWaitForLoad(link);
      link.remove()
    }, "'use-credentials' should send a credential to a same origin bundle");

    promise_test(async () => {
      const link = document.createElement("link");
      link.rel = "webbundle";
      link.href = cross_origin_bundle;
      link.crossOrigin = "use-credentials";
      await addLinkAndWaitForLoad(link);
      link.remove()
    }, "'use-credentials' should send a credential to a cross origin bundle");

    function addLinkAndWaitForLoad(link) {
      return new Promise((resolve, reject) => {
        link.onload = resolve;
        link.onerror = reject;
        document.body.appendChild(link);
      });
    }

    function addLinkAndWaitForError(link) {
      return new Promise((resolve, reject) => {
        link.onload = reject;
        link.onerror = resolve;
        document.body.appendChild(link);
      });
    }
  </script>
</body>
